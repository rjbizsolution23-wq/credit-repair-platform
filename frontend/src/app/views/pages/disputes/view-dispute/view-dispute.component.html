<div class="view-dispute">
  <!-- Page Header -->
  <div class="page-header">
    <div class="container-fluid">
      <div class="row align-items-center">
        <div class="col">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <a routerLink="/disputes">Disputes</a>
              </li>
              <li class="breadcrumb-item">
                <a routerLink="/disputes/active">Active Disputes</a>
              </li>
              <li class="breadcrumb-item active" aria-current="page">
                {{ dispute?.id || 'Dispute Details' }}
              </li>
            </ol>
          </nav>
          <h1 *ngIf="dispute">
            Dispute #{{ dispute.id }}
            <span class="badge ms-2" [ngClass]="getStatusClass(dispute.status)">
              {{ dispute.status | titlecase }}
            </span>
          </h1>
        </div>
        <div class="col-auto">
          <div class="header-actions">
            <button type="button" class="btn btn-outline-secondary" (click)="refresh()">
              <i class="fas fa-sync-alt"></i>
              Refresh
            </button>
            <button type="button" class="btn btn-outline-primary" (click)="duplicateDispute()">
              <i class="fas fa-copy"></i>
              Duplicate
            </button>
            <button type="button" class="btn btn-primary" (click)="editDispute()">
              <i class="fas fa-edit"></i>
              Edit
            </button>
            <button type="button" class="btn btn-outline-danger" (click)="confirmDelete()">
              <i class="fas fa-trash"></i>
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <div class="loading-text">Loading dispute details...</div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <div class="error-icon">
      <i class="fas fa-exclamation-triangle"></i>
    </div>
    <div class="error-message">{{ error }}</div>
    <button type="button" class="btn btn-primary btn-retry" (click)="loadDispute()">
      <i class="fas fa-redo"></i>
      Try Again
    </button>
  </div>

  <!-- Main Content -->
  <div *ngIf="dispute && !loading" class="main-content">
    <div class="container-fluid">
      <div class="row">
        <!-- Left Column - Main Details -->
        <div class="col-lg-8">
          <!-- Summary Card -->
          <div class="summary-card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-info-circle me-2"></i>
                Dispute Summary
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="info-item">
                    <label>Client:</label>
                    <span>{{ dispute.client_name }}</span>
                  </div>
                  <div class="info-item">
                    <label>Type:</label>
                    <span>{{ dispute.type | titlecase }}</span>
                  </div>
                  <div class="info-item">
                    <label>Priority:</label>
                    <span [ngClass]="getPriorityClass(dispute.priority)">
                      <i class="fas fa-flag me-1"></i>
                      {{ dispute.priority | titlecase }}
                    </span>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="info-item">
                    <label>Created:</label>
                    <span>{{ formatDateTime(dispute.created_date) }}</span>
                  </div>
                  <div class="info-item">
                    <label>Due Date:</label>
                    <span [ngClass]="getDaysRemaining(dispute.due_date) < 0 ? 'text-danger' : getDaysRemaining(dispute.due_date) <= 7 ? 'text-warning' : 'text-success'">
                      {{ formatDate(dispute.due_date) }}
                      <small class="ms-1">
                        ({{ getDaysRemaining(dispute.due_date) > 0 ? getDaysRemaining(dispute.due_date) + ' days left' : abs(getDaysRemaining(dispute.due_date)) + ' days overdue' }})
                      </small>
                    </span>
                  </div>
                  <div class="info-item">
                    <label>Progress:</label>
                    <div class="progress-container">
                      <div class="progress">
                        <div class="progress-bar" [style.width.%]="getProgressPercentage()" role="progressbar">
                          {{ getProgressPercentage() }}%
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="row mt-3" *ngIf="dispute.bureau">
                <div class="col-12">
                  <div class="info-item">
                    <label>Credit Bureau:</label>
                    <div class="bureau-badges">
                      <span class="badge badge-outline me-2">
                        {{ dispute.bureau }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Tab Navigation -->
          <div class="tab-navigation">
            <ul class="nav nav-tabs">
              <li class="nav-item">
                <button class="nav-link" [class.active]="activeTab === 'overview'" (click)="setActiveTab('overview')">
                  <i class="fas fa-eye me-2"></i>
                  Overview
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link" [class.active]="activeTab === 'items'" (click)="setActiveTab('items')">
                  <i class="fas fa-list me-2"></i>
                  Items ({{ dispute.dispute_items?.length || 0 }})
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link" [class.active]="activeTab === 'letters'" (click)="setActiveTab('letters')">
                  <i class="fas fa-envelope me-2"></i>
                  Letters ({{ dispute.attachments?.length || 0 }})
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link" [class.active]="activeTab === 'history'" (click)="setActiveTab('history')">
                  <i class="fas fa-history me-2"></i>
                  History
                </button>
              </li>
            </ul>
          </div>

          <!-- Tab Content -->
          <div class="tab-content">
            <!-- Overview Tab -->
            <div *ngIf="activeTab === 'overview'" class="tab-pane">
              <div class="overview-content">
                <div class="info-section">
                  <h6>Dispute Reason</h6>
                  <p>{{ dispute.reason || 'No reason provided' }}</p>
                </div>
                
                <div class="info-section" *ngIf="dispute.description">
                  <h6>Description</h6>
                  <p>{{ dispute.description }}</p>
                </div>
                
                <div class="info-section" *ngIf="dispute.notes">
                  <h6>Notes</h6>
                  <p>{{ dispute.notes }}</p>
                </div>
              </div>
            </div>

            <!-- Items Tab -->
            <div *ngIf="activeTab === 'items'" class="tab-pane">
              <div class="items-content">
                <div *ngIf="!dispute.dispute_items?.length" class="empty-state">
                  <div class="empty-icon">
                    <i class="fas fa-list"></i>
                  </div>
                  <h6>No Dispute Items</h6>
                  <p>No items have been added to this dispute yet.</p>
                </div>
                
                <div *ngFor="let item of dispute.dispute_items; trackBy: trackByItemId" class="dispute-item">
                  <div class="item-header">
                    <h6 class="item-title">{{ item.account_name }}</h6>
                    <span class="badge" [ngClass]="'badge-' + item.status.toLowerCase()">
                      {{ item.status | titlecase }}
                    </span>
                  </div>
                  <div class="item-details">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="detail-item">
                          <label>Account Number:</label>
                          <span>{{ item.account_number || 'N/A' }}</span>
                        </div>
                        <div class="detail-item">
                          <label>Status:</label>
                          <span>{{ item.status | titlecase }}</span>
                        </div>
                        <div class="detail-item">
                          <label>Balance:</label>
                          <span>{{ formatCurrency(item.balance) }}</span>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="detail-item">
                          <label>Dispute Reason:</label>
                          <span>{{ item.dispute_reason }}</span>
                        </div>
                        <div class="detail-item">
                          <label>Description:</label>
                          <span>{{ item.description }}</span>
                        </div>
                        <!-- Date Opened not available in DisputeItem interface -->
                      </div>
                    </div>
                    <div class="row mt-2" *ngIf="item.description">
                      <div class="col-12">
                        <div class="detail-item">
                          <label>Notes:</label>
                          <span>{{ item.description }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Letters Tab -->
            <div *ngIf="activeTab === 'letters'" class="tab-pane">
              <div class="letters-content">
                <div *ngIf="!dispute.attachments?.length" class="empty-state">
                  <div class="empty-icon">
                    <i class="fas fa-envelope"></i>
                  </div>
                  <h6>No Letters Generated</h6>
                  <p>No dispute letters have been generated for this dispute yet.</p>
                </div>
                
                <div *ngFor="let letter of dispute.attachments; trackBy: trackByLetterId" class="letter-item">
                  <div class="letter-header">
                    <div class="letter-info">
                      <h6 class="letter-title">{{ letter.filename }}</h6>
                      <small class="text-muted">{{ letter.file_type }} • {{ formatDateTime(letter.uploaded_date) }}</small>
                    </div>
                    <div class="letter-actions">
                      <button type="button" class="btn btn-sm btn-outline-primary" (click)="viewLetter(letter)">
                        <i class="fas fa-eye"></i>
                        View
                      </button>
                      <button type="button" class="btn btn-sm btn-primary" (click)="downloadLetter(letter)">
                        <i class="fas fa-download"></i>
                        Download
                      </button>
                    </div>
                  </div>
                  <div class="letter-preview" *ngIf="letter.description">
                      <p>{{ letter.description }}</p>
                    </div>
                </div>
              </div>
            </div>

            <!-- History Tab -->
            <div *ngIf="activeTab === 'history'" class="tab-pane">
              <div class="history-content">
                <div *ngIf="!getDisputeHistory()?.length" class="empty-state">
                  <div class="empty-icon">
                    <i class="fas fa-history"></i>
                  </div>
                  <h6>No History Available</h6>
                  <p>No activity history is available for this dispute.</p>
                </div>
                
                <div class="timeline">
                  <div *ngFor="let event of getDisputeHistory(); trackBy: trackByEventId" class="timeline-item">
                    <div class="timeline-marker">
                      <i class="fas" [ngClass]="getEventIcon(event.type)"></i>
                    </div>
                    <div class="timeline-content">
                      <div class="timeline-header">
                        <h6 class="timeline-title">{{ event.title }}</h6>
                        <small class="timeline-date">{{ formatDateTime(event.timestamp) }}</small>
                      </div>
                      <p class="timeline-description">{{ event.description }}</p>
                      <small class="timeline-user" *ngIf="event.user">
                        by {{ event.user }}
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column - Quick Actions & Status -->
        <div class="col-lg-4">
          <!-- Quick Actions -->
          <div class="quick-actions">
            <div class="card-header">
              <h6 class="card-title mb-0">
                <i class="fas fa-bolt me-2"></i>
                Quick Actions
              </h6>
            </div>
            <div class="card-body">
              <div class="action-group">
                <label>Update Status:</label>
                <div class="btn-group-vertical w-100">
                  <button *ngFor="let status of [DisputeStatus.SUBMITTED, DisputeStatus.IN_PROGRESS, DisputeStatus.UNDER_REVIEW, DisputeStatus.RESOLVED, DisputeStatus.REJECTED]" 
                          type="button" 
                          class="btn btn-sm" 
                          [class.btn-primary]="dispute.status === status"
                          [class.btn-outline-secondary]="dispute.status !== status"
                          [disabled]="dispute.status === status"
                          (click)="updateStatus(status)">
                    {{ status | titlecase }}
                  </button>
                </div>
              </div>
              
              <div class="action-group">
                <label>Update Priority:</label>
                <div class="btn-group-vertical w-100">
                  <button *ngFor="let priority of [DisputePriority.LOW, DisputePriority.MEDIUM, DisputePriority.HIGH, DisputePriority.URGENT]" 
                          type="button" 
                          class="btn btn-sm" 
                          [class.btn-primary]="dispute.priority === priority"
                          [class.btn-outline-secondary]="dispute.priority !== priority"
                          [disabled]="dispute.priority === priority"
                          (click)="updatePriority(priority)">
                    <i class="fas fa-flag me-1" [ngClass]="getPriorityClass(priority)"></i>
                    {{ priority | titlecase }}
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Statistics -->
          <div class="statistics-card">
            <div class="card-header">
              <h6 class="card-title mb-0">
                <i class="fas fa-chart-bar me-2"></i>
                Statistics
              </h6>
            </div>
            <div class="card-body">
              <div class="stat-item">
                <div class="stat-value">{{ dispute.dispute_items?.length || 0 }}</div>
                <div class="stat-label">Items</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">{{ getProgressPercentage() }}%</div>
                <div class="stat-label">Completed</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">{{ dispute.attachments?.length || 0 }}</div>
                <div class="stat-label">Attachments</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">{{ getDaysRemaining(dispute.due_date) }}</div>
                <div class="stat-label">Days Remaining</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" [class.show]="showDeleteModal" [style.display]="showDeleteModal ? 'block' : 'none'" *ngIf="showDeleteModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-exclamation-triangle text-danger me-2"></i>
            Confirm Delete
          </h5>
          <button type="button" class="btn-close" (click)="closeModal()"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete this dispute?</p>
          <p class="text-muted">This action cannot be undone. All associated data will be permanently removed.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
          <button type="button" class="btn btn-danger" (click)="deleteDispute()">
            <i class="fas fa-trash me-2"></i>
            Delete Dispute
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Letter View Modal -->
  <div class="modal fade" [class.show]="showLetterModal" [style.display]="showLetterModal ? 'block' : 'none'" *ngIf="showLetterModal && selectedLetter">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-envelope me-2"></i>
            {{ selectedLetter.type | titlecase }} Letter - {{ selectedLetter.bureau }}
          </h5>
          <button type="button" class="btn-close" (click)="closeModal()"></button>
        </div>
        <div class="modal-body">
          <div class="letter-content" [innerHTML]="selectedLetter.content"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Close</button>
          <button type="button" class="btn btn-primary" (click)="downloadLetter(selectedLetter)">
            <i class="fas fa-download me-2"></i>
            Download
          </button>
        </div>
      </div>
    </div>
  </div>
</div>