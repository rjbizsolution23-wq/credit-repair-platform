<!-- Page Header -->
<div class="page-header">
  <div class="header-content">
    <div class="header-left">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a routerLink="/dashboard">Dashboard</a>
          </li>
          <li class="breadcrumb-item">
            <a routerLink="/disputes">Disputes</a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">Analytics</li>
        </ol>
      </nav>
      <h1 class="page-title">
        <i class="fas fa-chart-bar"></i>
        Dispute Analytics
      </h1>
      <p class="page-description">Insights and performance metrics for dispute management</p>
    </div>
    <div class="header-actions">
      <button type="button" class="btn btn-outline-secondary" (click)="toggleFilters()">
        <i class="fas fa-filter"></i>
        Filters
      </button>
      <div class="dropdown">
        <button 
          class="btn btn-outline-primary dropdown-toggle" 
          type="button" 
          data-bs-toggle="dropdown"
          [disabled]="exportLoading">
          <span *ngIf="!exportLoading">
            <i class="fas fa-download"></i>
            Export
          </span>
          <span *ngIf="exportLoading">
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            Exporting...
          </span>
        </button>
        <ul class="dropdown-menu">
          <li>
            <a class="dropdown-item" href="#" (click)="exportData('pdf'); $event.preventDefault()">
              <i class="fas fa-file-pdf text-danger"></i>
              Export as PDF
            </a>
          </li>
          <li>
            <a class="dropdown-item" href="#" (click)="exportData('excel'); $event.preventDefault()">
              <i class="fas fa-file-excel text-success"></i>
              Export as Excel
            </a>
          </li>
          <li>
            <a class="dropdown-item" href="#" (click)="exportData('csv'); $event.preventDefault()">
              <i class="fas fa-file-csv text-info"></i>
              Export as CSV
            </a>
          </li>
        </ul>
      </div>
      <button type="button" class="btn btn-primary" (click)="refresh()">
        <i class="fas fa-sync-alt"></i>
        Refresh
      </button>
    </div>
  </div>
</div>

<!-- Loading State -->
<div *ngIf="loading" class="loading-container">
  <div class="loading-spinner">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="loading-text">Loading analytics data...</p>
  </div>
</div>

<!-- Error State -->
<div *ngIf="error && !loading" class="alert alert-danger" role="alert">
  <i class="fas fa-exclamation-triangle"></i>
  {{ error }}
  <button type="button" class="btn btn-sm btn-outline-danger ms-2" (click)="refresh()">
    Try Again
  </button>
</div>

<!-- Main Content -->
<div *ngIf="!loading && !error && analyticsData" class="main-content">
  <!-- Filters Panel -->
  <div class="filters-panel" [class.show]="showFilters">
    <div class="panel-header">
      <h5>Filters</h5>
      <button type="button" class="btn btn-sm btn-outline-secondary" (click)="clearFilters()">
        Clear All
      </button>
    </div>
    
    <form [formGroup]="filtersForm" class="filters-form">
      <div class="row g-3">
        <!-- Date Range -->
        <div class="col-md-6" formGroupName="dateRange">
          <label class="form-label">Date Range</label>
          <select class="form-select mb-2" formControlName="preset">
            <option *ngFor="let preset of datePresets" [value]="preset.value">
              {{ preset.label }}
            </option>
          </select>
          <div class="row g-2" *ngIf="filtersForm.get('dateRange.preset')?.value === 'custom'">
            <div class="col-6">
              <input type="date" class="form-control" formControlName="start" placeholder="Start Date">
            </div>
            <div class="col-6">
              <input type="date" class="form-control" formControlName="end" placeholder="End Date">
            </div>
          </div>
        </div>
        
        <!-- Client Search -->
        <div class="col-md-6">
          <label class="form-label">Client</label>
          <input 
            type="text" 
            class="form-control" 
            formControlName="client"
            placeholder="Search by client name or ID">
        </div>
        
        <!-- Status Filter -->
        <div class="col-md-3">
          <label class="form-label">Status</label>
          <div class="checkbox-group">
            <div class="form-check" *ngFor="let option of statusOptions">
              <input 
                class="form-check-input" 
                type="checkbox" 
                [id]="'status-' + option.value"
                [checked]="filtersForm.get('status')?.value?.includes(option.value)"
                (change)="onStatusChange(option.value, $any($event.target).checked)">
              <label class="form-check-label" [for]="'status-' + option.value">
                {{ option.label }}
              </label>
            </div>
          </div>
        </div>
        
        <!-- Priority Filter -->
        <div class="col-md-3">
          <label class="form-label">Priority</label>
          <div class="checkbox-group">
            <div class="form-check" *ngFor="let option of priorityOptions">
              <input 
                class="form-check-input" 
                type="checkbox" 
                [id]="'priority-' + option.value"
                [checked]="filtersForm.get('priority')?.value?.includes(option.value)"
                (change)="onPriorityChange(option.value, $any($event.target).checked)">
              <label class="form-check-label" [for]="'priority-' + option.value">
                {{ option.label }}
              </label>
            </div>
          </div>
        </div>
        
        <!-- Type Filter -->
        <div class="col-md-3">
          <label class="form-label">Type</label>
          <div class="checkbox-group">
            <div class="form-check" *ngFor="let option of typeOptions">
              <input 
                class="form-check-input" 
                type="checkbox" 
                [id]="'type-' + option.value"
                [checked]="filtersForm.get('type')?.value?.includes(option.value)"
                (change)="onTypeChange(option.value, $any($event.target).checked)">
              <label class="form-check-label" [for]="'type-' + option.value">
                {{ option.label }}
              </label>
            </div>
          </div>
        </div>
        
        <!-- Credit Bureau Filter -->
        <div class="col-md-3">
          <label class="form-label">Credit Bureau</label>
          <div class="checkbox-group">
            <div class="form-check" *ngFor="let option of creditBureauOptions">
              <input 
                class="form-check-input" 
                type="checkbox" 
                [id]="'bureau-' + option.value"
                [checked]="filtersForm.get('creditBureau')?.value?.includes(option.value)"
                (change)="onCreditBureauChange(option.value, $any($event.target).checked)">
              <label class="form-check-label" [for]="'bureau-' + option.value">
                {{ option.label }}
              </label>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button 
          class="nav-link" 
          [class.active]="activeTab === 'overview'"
          (click)="setActiveTab('overview')"
          type="button">
          <i class="fas fa-tachometer-alt"></i>
          Overview
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button 
          class="nav-link" 
          [class.active]="activeTab === 'distributions'"
          (click)="setActiveTab('distributions')"
          type="button">
          <i class="fas fa-chart-pie"></i>
          Distributions
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button 
          class="nav-link" 
          [class.active]="activeTab === 'trends'"
          (click)="setActiveTab('trends')"
          type="button">
          <i class="fas fa-chart-line"></i>
          Trends
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button 
          class="nav-link" 
          [class.active]="activeTab === 'performance'"
          (click)="setActiveTab('performance')"
          type="button">
          <i class="fas fa-trophy"></i>
          Performance
        </button>
      </li>
    </ul>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Overview Tab -->
    <div class="tab-pane" [class.active]="activeTab === 'overview'">
      <!-- Key Metrics -->
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-icon">
            <i class="fas fa-file-alt text-primary"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatNumber(analyticsData.overview.totalDisputes) }}</div>
            <div class="metric-label">Total Disputes</div>
          </div>
        </div>
        
        <div class="metric-card">
          <div class="metric-icon">
            <i class="fas fa-clock text-warning"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatNumber(analyticsData.overview.activeDisputes) }}</div>
            <div class="metric-label">Active Disputes</div>
          </div>
        </div>
        
        <div class="metric-card">
          <div class="metric-icon">
            <i class="fas fa-check-circle text-success"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatNumber(analyticsData.overview.resolvedDisputes) }}</div>
            <div class="metric-label">Resolved Disputes</div>
          </div>
        </div>
        
        <div class="metric-card">
          <div class="metric-icon">
            <i class="fas fa-percentage text-info"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatPercentage(analyticsData.overview.successRate) }}</div>
            <div class="metric-label">Success Rate</div>
          </div>
        </div>
        
        <div class="metric-card">
          <div class="metric-icon">
            <i class="fas fa-calendar-alt text-secondary"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatDuration(analyticsData.overview.averageResolutionTime) }}</div>
            <div class="metric-label">Avg. Resolution Time</div>
          </div>
        </div>
        
        <div class="metric-card">
          <div class="metric-icon">
            <i class="fas fa-users text-purple"></i>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ formatNumber(analyticsData.overview.totalClientsAffected) }}</div>
            <div class="metric-label">Clients Affected</div>
          </div>
        </div>
      </div>
      
      <!-- Quick Charts -->
      <div class="row g-4 mt-4">
        <div class="col-md-6">
          <div class="chart-card">
            <div class="card-header">
              <h5>Status Distribution</h5>
            </div>
            <div class="card-body">
              <div class="chart-container" style="height: 300px;">
                <canvas 
                  *ngIf="getStatusChartData()"
                  baseChart
                  [data]="getStatusChartData()"
                  [options]="chartOptions"
                  type="doughnut">
                </canvas>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="chart-card">
            <div class="card-header">
              <h5>Priority Distribution</h5>
            </div>
            <div class="card-body">
              <div class="chart-container" style="height: 300px;">
                <canvas 
                  *ngIf="getPriorityChartData()"
                  baseChart
                  [data]="getPriorityChartData()"
                  [options]="chartOptions"
                  type="doughnut">
                </canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Distributions Tab -->
    <div class="tab-pane" [class.active]="activeTab === 'distributions'">
      <div class="row g-4">
        <!-- Status Distribution -->
        <div class="col-lg-6">
          <div class="chart-card">
            <div class="card-header">
              <h5>Status Distribution</h5>
            </div>
            <div class="card-body">
              <div class="chart-container" style="height: 400px;">
                <canvas 
                  *ngIf="getStatusChartData()"
                  baseChart
                  [data]="getStatusChartData()"
                  [options]="chartOptions"
                  type="pie">
                </canvas>
              </div>
              <div class="chart-legend">
                <div 
                  class="legend-item"
                  *ngFor="let item of analyticsData.statusDistribution">
                  <div class="legend-color" [style.background-color]="item.color"></div>
                  <div class="legend-label">{{ item.label }}</div>
                  <div class="legend-value">{{ formatNumber(item.value) }} ({{ formatPercentage(item.percentage) }})</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Priority Distribution -->
        <div class="col-lg-6">
          <div class="chart-card">
            <div class="card-header">
              <h5>Priority Distribution</h5>
            </div>
            <div class="card-body">
              <div class="chart-container" style="height: 400px;">
                <canvas 
                  *ngIf="getPriorityChartData()"
                  baseChart
                  [data]="getPriorityChartData()"
                  [options]="chartOptions"
                  type="pie">
                </canvas>
              </div>
              <div class="chart-legend">
                <div 
                  class="legend-item"
                  *ngFor="let item of analyticsData.priorityDistribution">
                  <div class="legend-color" [style.background-color]="item.color"></div>
                  <div class="legend-label">{{ item.label }}</div>
                  <div class="legend-value">{{ formatNumber(item.value) }} ({{ formatPercentage(item.percentage) }})</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Type Distribution -->
        <div class="col-12">
          <div class="chart-card">
            <div class="card-header">
              <h5>Dispute Type Distribution</h5>
            </div>
            <div class="card-body">
              <div class="type-distribution">
                <div 
                  class="type-item"
                  *ngFor="let item of analyticsData.typeDistribution">
                  <div class="type-header">
                    <span class="type-label">{{ item.label }}</span>
                    <span class="type-value">{{ formatNumber(item.value) }} ({{ formatPercentage(item.percentage) }})</span>
                  </div>
                  <div class="progress">
                    <div 
                      class="progress-bar"
                      [style.width.%]="item.percentage"
                      [attr.aria-valuenow]="item.percentage"
                      aria-valuemin="0"
                      aria-valuemax="100">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Resolution Time Distribution -->
        <div class="col-12">
          <div class="chart-card">
            <div class="card-header">
              <h5>Resolution Time Distribution</h5>
            </div>
            <div class="card-body">
              <div class="chart-container" style="height: 400px;">
                <canvas 
                  *ngIf="getResolutionTimeChartData()"
                  baseChart
                  [data]="getResolutionTimeChartData()"
                  [options]="chartOptions"
                  type="bar">
                </canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Trends Tab -->
    <div class="tab-pane" [class.active]="activeTab === 'trends'">
      <div class="row g-4">
        <!-- Monthly Trends -->
        <div class="col-12">
          <div class="chart-card">
            <div class="card-header">
              <h5>Monthly Trends</h5>
            </div>
            <div class="card-body">
              <div class="chart-container" style="height: 400px;">
                <canvas 
                  *ngIf="getTrendsChartData()"
                  baseChart
                  [data]="getTrendsChartData()"
                  [options]="chartOptions"
                  [type]="'line'">
                </canvas>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Success Rate Trend -->
        <div class="col-12">
          <div class="chart-card">
            <div class="card-header">
              <h5>Success Rate Trend</h5>
            </div>
            <div class="card-body">
              <div class="trend-table">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Month</th>
                        <th>Created</th>
                        <th>Resolved</th>
                        <th>Success Rate</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let trend of analyticsData.monthlyTrends">
                        <td>{{ trend.month }}</td>
                        <td>{{ formatNumber(trend.created) }}</td>
                        <td>{{ formatNumber(trend.resolved) }}</td>
                        <td>
                          <span [class]="getBadgeClass(trend.successRate)">
                            {{ formatPercentage(trend.successRate) }}
                          </span>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Performance Tab -->
    <div class="tab-pane" [class.active]="activeTab === 'performance'">
      <div class="row g-4">
        <!-- Bureau Performance -->
        <div class="col-12">
          <div class="chart-card">
            <div class="card-header">
              <h5>Credit Bureau Performance</h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Credit Bureau</th>
                      <th>Total Disputes</th>
                      <th>Resolved</th>
                      <th>Success Rate</th>
                      <th>Avg. Resolution Time</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let bureau of analyticsData.bureauPerformance">
                      <td>
                        <strong>{{ toTitleCase(bureau.bureau) }}</strong>
                      </td>
                      <td>{{ formatNumber(bureau.total) }}</td>
                      <td>{{ formatNumber(bureau.resolved) }}</td>
                      <td>
                        <span [class]="getBadgeClass(bureau.successRate)">
                          {{ formatPercentage(bureau.successRate) }}
                        </span>
                      </td>
                      <td>{{ formatDuration(bureau.averageTime) }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Top Clients -->
        <div class="col-12">
          <div class="chart-card">
            <div class="card-header">
              <h5>Top Clients by Dispute Volume</h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Client</th>
                      <th>Total Disputes</th>
                      <th>Resolved</th>
                      <th>Success Rate</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let client of analyticsData.topClients">
                      <td>
                        <div class="client-info">
                          <div class="client-avatar">
                            <i class="fas fa-user"></i>
                          </div>
                          <div class="client-details">
                            <div class="client-name">{{ client.clientName }}</div>
                            <div class="client-id">ID: {{ client.clientId }}</div>
                          </div>
                        </div>
                      </td>
                      <td>{{ formatNumber(client.totalDisputes) }}</td>
                      <td>{{ formatNumber(client.resolvedDisputes) }}</td>
                      <td>
                        <span [class]="getBadgeClass(client.successRate)">
                          {{ formatPercentage(client.successRate) }}
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Empty State -->
<div *ngIf="!loading && !error && !analyticsData" class="empty-state">
  <div class="empty-icon">
    <i class="fas fa-chart-bar"></i>
  </div>
  <h3>No Analytics Data</h3>
  <p>No dispute data available for the selected filters.</p>
  <button type="button" class="btn btn-primary" (click)="clearFilters()">
    Clear Filters
  </button>
</div>