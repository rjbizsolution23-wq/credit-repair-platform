<div class="progress-tracking-container">
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <h1 class="title">Progress Tracking</h1>
      <p class="subtitle">Monitor client credit improvement and goal achievement</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="exportData()">
        <i class="fas fa-download"></i>
        Export Data
      </button>
      <button class="btn btn-secondary" (click)="generateReport()">
        <i class="fas fa-chart-line"></i>
        Generate Report
      </button>
      <button class="btn btn-primary" (click)="openMetricModal()">
        <i class="fas fa-plus"></i>
        Add Metric
      </button>
    </div>
  </div>

  <!-- Progress Overview Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-chart-line text-teal-600"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ metrics.length }}</div>
        <div class="stat-label">Total Metrics</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-target text-blue-600"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ getActiveGoalsCount() }}</div>
        <div class="stat-label">Active Goals</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-trophy text-green-600"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ getCompletedGoalsCount() }}</div>
        <div class="stat-label">Completed Goals</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-trending-up text-purple-600"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ getImprovingMetricsCount() }}</div>
        <div class="stat-label">Improving Metrics</div>
      </div>
    </div>
  </div>

  <!-- Progress Chart -->
  <div class="chart-section" *ngIf="chartData">
    <div class="section-header">
      <h2>Progress Visualization</h2>
    </div>
    <div class="chart-container">
      <!-- Chart implementation would go here -->
      <div class="chart-placeholder">
        <i class="fas fa-chart-line"></i>
        <p>Progress Chart (Chart.js integration required)</p>
      </div>
    </div>
  </div>

  <!-- Metrics Section -->
  <div class="metrics-section">
    <div class="section-header">
      <h2>Progress Metrics</h2>
      <button class="btn btn-primary" (click)="openMetricModal()">
        <i class="fas fa-plus"></i>
        Add Metric
      </button>
    </div>

    <!-- Filters Panel -->
    <div class="filters-panel">
      <div class="filter-group">
        <label>Metric Type</label>
        <select [(ngModel)]="filters.metricType" (change)="applyFilters()" class="form-control">
          <option value="">All Types</option>
          <option value="credit_score">Credit Score</option>
          <option value="accounts_removed">Accounts Removed</option>
          <option value="positive_accounts">Positive Accounts</option>
          <option value="utilization">Credit Utilization</option>
          <option value="payment_history">Payment History</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Status</label>
        <select [(ngModel)]="filters.status" (change)="applyFilters()" class="form-control">
          <option value="">All Statuses</option>
          <option value="improving">Improving</option>
          <option value="declining">Declining</option>
          <option value="stable">Stable</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Client ID</label>
        <input type="text" [(ngModel)]="filters.clientId" (input)="applyFilters()" 
               placeholder="Search by client ID" class="form-control">
      </div>
      <div class="filter-actions">
        <button class="btn btn-secondary" (click)="clearFilters()">
          <i class="fas fa-times"></i>
          Clear
        </button>
      </div>
    </div>

    <!-- Metrics Table -->
    <div class="table-container" *ngIf="!loading && filteredMetrics.length > 0">
      <table class="data-table">
        <thead>
          <tr>
            <th (click)="sort('clientId')" class="sortable">
              Client ID
              <i class="fas fa-sort" [class.fa-sort-up]="sortField === 'clientId' && sortDirection === 'asc'"
                 [class.fa-sort-down]="sortField === 'clientId' && sortDirection === 'desc'"></i>
            </th>
            <th (click)="sort('metricType')" class="sortable">
              Metric Type
              <i class="fas fa-sort" [class.fa-sort-up]="sortField === 'metricType' && sortDirection === 'asc'"
                 [class.fa-sort-down]="sortField === 'metricType' && sortDirection === 'desc'"></i>
            </th>
            <th (click)="sort('currentValue')" class="sortable">
              Current Value
              <i class="fas fa-sort" [class.fa-sort-up]="sortField === 'currentValue' && sortDirection === 'asc'"
                 [class.fa-sort-down]="sortField === 'currentValue' && sortDirection === 'desc'"></i>
            </th>
            <th>Previous Value</th>
            <th>Target Value</th>
            <th>Change</th>
            <th (click)="sort('recordedDate')" class="sortable">
              Recorded Date
              <i class="fas fa-sort" [class.fa-sort-up]="sortField === 'recordedDate' && sortDirection === 'asc'"
                 [class.fa-sort-down]="sortField === 'recordedDate' && sortDirection === 'desc'"></i>
            </th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let metric of paginatedMetrics">
            <td>{{ metric.clientId }}</td>
            <td>{{ getMetricTypeLabel(metric.metricType) }}</td>
            <td class="font-semibold">{{ metric.currentValue }}</td>
            <td>{{ metric.previousValue }}</td>
            <td>{{ metric.targetValue }}</td>
            <td>
              <span [class]="metric.changeAmount >= 0 ? 'text-green-600' : 'text-red-600'">
                {{ metric.changeAmount >= 0 ? '+' : '' }}{{ metric.changeAmount }}
                ({{ metric.changePercentage >= 0 ? '+' : '' }}{{ metric.changePercentage }}%)
              </span>
            </td>
            <td>{{ formatDate(metric.recordedDate) }}</td>
            <td>
              <span class="status-badge" [class]="getStatusClass(metric.status)">
                {{ metric.status | titlecase }}
              </span>
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn-icon" (click)="openMetricModal(metric)" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon text-red-600" (click)="confirmDelete(metric, 'metric')" title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="!loading && filteredMetrics.length === 0">
      <i class="fas fa-chart-line"></i>
      <h3>No Progress Metrics Found</h3>
      <p>Start tracking client progress by adding metrics.</p>
      <button class="btn btn-primary" (click)="openMetricModal()">
        <i class="fas fa-plus"></i>
        Add First Metric
      </button>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="loading">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Loading progress metrics...</p>
    </div>

    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPages > 1">
      <button class="btn btn-secondary" [disabled]="currentPage === 1" (click)="changePage(currentPage - 1)">
        <i class="fas fa-chevron-left"></i>
        Previous
      </button>
      <span class="page-info">
        Page {{ currentPage }} of {{ totalPages }} ({{ totalItems }} total)
      </span>
      <button class="btn btn-secondary" [disabled]="currentPage === totalPages" (click)="changePage(currentPage + 1)">
        Next
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>

  <!-- Goals Section -->
  <div class="goals-section">
    <div class="section-header">
      <h2>Progress Goals</h2>
      <button class="btn btn-primary" (click)="openGoalModal()">
        <i class="fas fa-plus"></i>
        Add Goal
      </button>
    </div>

    <!-- Goal Filters -->
    <div class="filters-panel">
      <div class="filter-group">
        <label>Goal Type</label>
        <select [(ngModel)]="goalFilters.goalType" (change)="applyGoalFilters()" class="form-control">
          <option value="">All Types</option>
          <option value="credit_score">Credit Score</option>
          <option value="debt_reduction">Debt Reduction</option>
          <option value="account_removal">Account Removal</option>
          <option value="utilization_target">Utilization Target</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Status</label>
        <select [(ngModel)]="goalFilters.status" (change)="applyGoalFilters()" class="form-control">
          <option value="">All Statuses</option>
          <option value="active">Active</option>
          <option value="completed">Completed</option>
          <option value="paused">Paused</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Priority</label>
        <select [(ngModel)]="goalFilters.priority" (change)="applyGoalFilters()" class="form-control">
          <option value="">All Priorities</option>
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>
      </div>
      <div class="filter-actions">
        <button class="btn btn-secondary" (click)="clearGoalFilters()">
          <i class="fas fa-times"></i>
          Clear
        </button>
      </div>
    </div>

    <!-- Goals Grid -->
    <div class="goals-grid" *ngIf="filteredGoals.length > 0">
      <div class="goal-card" *ngFor="let goal of filteredGoals">
        <div class="goal-header">
          <h3>{{ goal.title }}</h3>
          <div class="goal-actions">
            <button class="btn-icon" (click)="openGoalModal(goal)" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-icon text-red-600" (click)="confirmDelete(goal, 'goal')" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        <p class="goal-description">{{ goal.description }}</p>
        <div class="goal-progress">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="calculateProgress(goal.currentValue, goal.targetValue)"></div>
          </div>
          <span class="progress-text">
            {{ goal.currentValue }} / {{ goal.targetValue }} 
            ({{ calculateProgress(goal.currentValue, goal.targetValue) | number:'1.0-0' }}%)
          </span>
        </div>
        <div class="goal-meta">
          <div class="goal-dates">
            <span><i class="fas fa-calendar-start"></i> {{ formatDate(goal.startDate) }}</span>
            <span><i class="fas fa-calendar-check"></i> {{ formatDate(goal.targetDate) }}</span>
          </div>
          <div class="goal-badges">
            <span class="status-badge" [class]="getStatusClass(goal.status)">
              {{ goal.status | titlecase }}
            </span>
            <span class="priority-badge" [class]="getPriorityClass(goal.priority)">
              {{ goal.priority | titlecase }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Goals Empty State -->
    <div class="empty-state" *ngIf="filteredGoals.length === 0">
      <i class="fas fa-target"></i>
      <h3>No Goals Found</h3>
      <p>Set progress goals to track client achievements.</p>
      <button class="btn btn-primary" (click)="openGoalModal()">
        <i class="fas fa-plus"></i>
        Add First Goal
      </button>
    </div>
  </div>
</div>

<!-- Metric Modal -->
<div class="modal-overlay" *ngIf="showMetricModal" (click)="closeModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ editingMetric ? 'Edit' : 'Add' }} Progress Metric</h2>
      <button class="btn-close" (click)="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form [formGroup]="metricForm" (ngSubmit)="saveMetric()" class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label for="clientId">Client ID *</label>
          <input type="text" id="clientId" formControlName="clientId" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="metricType">Metric Type *</label>
          <select id="metricType" formControlName="metricType" class="form-control" required>
            <option value="">Select type</option>
            <option value="credit_score">Credit Score</option>
            <option value="accounts_removed">Accounts Removed</option>
            <option value="positive_accounts">Positive Accounts</option>
            <option value="utilization">Credit Utilization</option>
            <option value="payment_history">Payment History</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="currentValue">Current Value *</label>
          <input type="number" id="currentValue" formControlName="currentValue" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="previousValue">Previous Value *</label>
          <input type="number" id="previousValue" formControlName="previousValue" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="targetValue">Target Value *</label>
          <input type="number" id="targetValue" formControlName="targetValue" class="form-control" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="recordedDate">Recorded Date *</label>
          <input type="date" id="recordedDate" formControlName="recordedDate" class="form-control" required>
        </div>
      </div>
      <div class="form-group">
        <label for="notes">Notes</label>
        <textarea id="notes" formControlName="notes" class="form-control" rows="3" 
                  placeholder="Additional notes about this metric..."></textarea>
      </div>
    </form>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
      <button type="submit" class="btn btn-primary" (click)="saveMetric()" [disabled]="!metricForm.valid">
        {{ editingMetric ? 'Update' : 'Create' }} Metric
      </button>
    </div>
  </div>
</div>

<!-- Goal Modal -->
<div class="modal-overlay" *ngIf="showGoalModal" (click)="closeModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ editingGoal ? 'Edit' : 'Add' }} Progress Goal</h2>
      <button class="btn-close" (click)="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form [formGroup]="goalForm" (ngSubmit)="saveGoal()" class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label for="goalClientId">Client ID *</label>
          <input type="text" id="goalClientId" formControlName="clientId" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="goalType">Goal Type *</label>
          <select id="goalType" formControlName="goalType" class="form-control" required>
            <option value="">Select type</option>
            <option value="credit_score">Credit Score</option>
            <option value="debt_reduction">Debt Reduction</option>
            <option value="account_removal">Account Removal</option>
            <option value="utilization_target">Utilization Target</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label for="goalTitle">Title *</label>
        <input type="text" id="goalTitle" formControlName="title" class="form-control" required>
      </div>
      <div class="form-group">
        <label for="goalDescription">Description</label>
        <textarea id="goalDescription" formControlName="description" class="form-control" rows="3" 
                  placeholder="Describe the goal..."></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="goalCurrentValue">Current Value *</label>
          <input type="number" id="goalCurrentValue" formControlName="currentValue" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="goalTargetValue">Target Value *</label>
          <input type="number" id="goalTargetValue" formControlName="targetValue" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="goalPriority">Priority *</label>
          <select id="goalPriority" formControlName="priority" class="form-control" required>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="goalStartDate">Start Date *</label>
          <input type="date" id="goalStartDate" formControlName="startDate" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="goalTargetDate">Target Date *</label>
          <input type="date" id="goalTargetDate" formControlName="targetDate" class="form-control" required>
        </div>
      </div>
    </form>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
      <button type="submit" class="btn btn-primary" (click)="saveGoal()" [disabled]="!goalForm.valid">
        {{ editingGoal ? 'Update' : 'Create' }} Goal
      </button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" *ngIf="showDeleteModal" (click)="closeModal()">
  <div class="modal modal-sm" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirm Delete</h2>
      <button class="btn-close" (click)="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to delete this {{ deletingItem?.type }}? This action cannot be undone.</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
      <button type="button" class="btn btn-danger" (click)="deleteItem()">
        <i class="fas fa-trash"></i>
        Delete
      </button>
    </div>
  </div>
</div>