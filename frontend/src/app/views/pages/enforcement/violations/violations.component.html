<div class="violations">
  <!-- Page Header -->
  <div class="page-header">
    <div class="row align-items-center">
      <div class="col">
        <div class="page-header-title">
          <h4 class="page-title">Violations</h4>
          <div class="page-header-breadcrumb">
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a routerLink="/dashboard">Dashboard</a></li>
                <li class="breadcrumb-item"><a routerLink="/enforcement">Enforcement</a></li>
                <li class="breadcrumb-item active" aria-current="page">Violations</li>
              </ol>
            </nav>
          </div>
        </div>
      </div>
      <div class="col-auto">
        <div class="page-header-actions">
          <button 
            type="button" 
            class="btn btn-outline-secondary btn-sm me-2"
            (click)="toggleFilters()">
            <i data-feather="filter" appFeatherIcon class="me-1"></i>
            Filters
          </button>
          <div class="dropdown d-inline-block me-2">
            <button 
              class="btn btn-outline-primary btn-sm dropdown-toggle" 
              type="button" 
              data-bs-toggle="dropdown">
              <i data-feather="download" appFeatherIcon class="me-1"></i>
              Export
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" (click)="exportViolations('csv')">Export as CSV</a></li>
              <li><a class="dropdown-item" (click)="exportViolations('excel')">Export as Excel</a></li>
              <li><a class="dropdown-item" (click)="exportViolations('pdf')">Export as PDF</a></li>
            </ul>
          </div>
          <button 
            type="button" 
            class="btn btn-outline-primary btn-sm me-2"
            [disabled]="refreshing"
            (click)="refreshData()">
            <i data-feather="refresh-cw" appFeatherIcon [class.spin]="refreshing" class="me-1"></i>
            Refresh
          </button>
          <button 
            type="button" 
            class="btn btn-primary btn-sm"
            (click)="createViolation()">
            <i data-feather="plus" appFeatherIcon class="me-1"></i>
            Report Violation
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Panel -->
  <div class="filters-panel" [class.show]="showFilters">
    <div class="card">
      <div class="card-body">
        <form [formGroup]="filterForm">
          <div class="row">
            <!-- Search -->
            <div class="col-md-3 mb-3">
              <label class="form-label">Search</label>
              <input 
                type="text" 
                class="form-control" 
                formControlName="search"
                placeholder="Search violations...">
            </div>
            
            <!-- Type -->
            <div class="col-md-3 mb-3">
              <label class="form-label">Type</label>
              <select class="form-select" formControlName="type">
                <option value="">All Types</option>
                <option *ngFor="let type of ViolationType | keyvalue" [value]="type.value">
                  {{ getViolationTypeLabel(type.value) }}
                </option>
              </select>
            </div>
            
            <!-- Severity -->
            <div class="col-md-3 mb-3">
              <label class="form-label">Severity</label>
              <select class="form-select" formControlName="severity">
                <option value="">All Severities</option>
                <option *ngFor="let severity of ViolationSeverity | keyvalue" [value]="severity.value">
                  {{ getViolationSeverityLabel(severity.value) }}
                </option>
              </select>
            </div>
            
            <!-- Status -->
            <div class="col-md-3 mb-3">
              <label class="form-label">Status</label>
              <select class="form-select" formControlName="status">
                <option value="">All Statuses</option>
                <option *ngFor="let status of ViolationStatus | keyvalue" [value]="status.value">
                  {{ getViolationStatusLabel(status.value) }}
                </option>
              </select>
            </div>
            
            <!-- Reported By -->
            <div class="col-md-3 mb-3">
              <label class="form-label">Reported By</label>
              <input 
                type="text" 
                class="form-control" 
                formControlName="reportedBy"
                placeholder="Reporter name...">
            </div>
            
            <!-- Date From -->
            <div class="col-md-3 mb-3">
              <label class="form-label">Date From</label>
              <input 
                type="date" 
                class="form-control" 
                formControlName="dateFrom">
            </div>
            
            <!-- Date To -->
            <div class="col-md-3 mb-3">
              <label class="form-label">Date To</label>
              <input 
                type="date" 
                class="form-control" 
                formControlName="dateTo">
            </div>
            
            <!-- Actions -->
            <div class="col-md-3 mb-3 d-flex align-items-end">
              <button 
                type="button" 
                class="btn btn-outline-secondary"
                (click)="clearFilters()">
                <i data-feather="x" appFeatherIcon class="me-1"></i>
                Clear
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bulk Actions -->
  <div class="bulk-actions" *ngIf="selectedViolations.length > 0">
    <div class="card">
      <div class="card-body py-2">
        <div class="d-flex align-items-center justify-content-between">
          <span class="text-muted">
            {{ selectedViolations.length }} violation(s) selected
          </span>
          <div class="bulk-action-buttons">
            <button 
              type="button" 
              class="btn btn-outline-success btn-sm me-2"
              (click)="executeBulkAction('resolve')">
              <i data-feather="check" appFeatherIcon class="me-1"></i>
              Resolve
            </button>
            <button 
              type="button" 
              class="btn btn-outline-secondary btn-sm me-2"
              (click)="executeBulkAction('close')">
              <i data-feather="x-circle" appFeatherIcon class="me-1"></i>
              Close
            </button>
            <button 
              type="button" 
              class="btn btn-outline-danger btn-sm"
              (click)="executeBulkAction('delete')">
              <i data-feather="trash-2" appFeatherIcon class="me-1"></i>
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 text-muted">Loading violations...</p>
    </div>
  </div>

  <!-- Violations Table -->
  <div *ngIf="!loading" class="violations-table">
    <div class="card">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th width="40">
                <div class="form-check">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    [checked]="allViolationsSelected"
                    [indeterminate]="someViolationsSelected"
                    (change)="toggleAllViolations()">
                </div>
              </th>
              <th 
                class="sortable" 
                (click)="onSort('title')">
                Title
                <i [attr.data-feather]="getSortIcon('title')" appFeatherIcon class="sort-icon"></i>
              </th>
              <th 
                class="sortable" 
                (click)="onSort('type')">
                Type
                <i [attr.data-feather]="getSortIcon('type')" appFeatherIcon class="sort-icon"></i>
              </th>
              <th 
                class="sortable" 
                (click)="onSort('severity')">
                Severity
                <i [attr.data-feather]="getSortIcon('severity')" appFeatherIcon class="sort-icon"></i>
              </th>
              <th 
                class="sortable" 
                (click)="onSort('status')">
                Status
                <i [attr.data-feather]="getSortIcon('status')" appFeatherIcon class="sort-icon"></i>
              </th>
              <th 
                class="sortable" 
                (click)="onSort('reportedBy')">
                Reported By
                <i [attr.data-feather]="getSortIcon('reportedBy')" appFeatherIcon class="sort-icon"></i>
              </th>
              <th 
                class="sortable" 
                (click)="onSort('reportedDate')">
                Reported Date
                <i [attr.data-feather]="getSortIcon('reportedDate')" appFeatherIcon class="sort-icon"></i>
              </th>
              <th>Risk Level</th>
              <th width="120">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="violations.length === 0">
              <td colspan="9" class="text-center py-4">
                <i data-feather="search" appFeatherIcon class="text-muted mb-2" style="width: 48px; height: 48px;"></i>
                <p class="text-muted mb-0">No violations found</p>
              </td>
            </tr>
            <tr *ngFor="let violation of violations" class="violation-row">
              <td>
                <div class="form-check">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    [checked]="isViolationSelected(violation.id)"
                    (change)="toggleViolationSelection(violation.id)">
                </div>
              </td>
              <td>
                <div class="violation-title">
                  <a 
                    [routerLink]="[violation.id]" 
                    class="fw-semibold text-decoration-none">
                    {{ violation.title }}
                  </a>
                  <div class="violation-description text-muted small mt-1">
                    {{ violation.description | slice:0:100 }}<span *ngIf="violation.description.length > 100">...</span>
                  </div>
                </div>
              </td>
              <td>
                <span class="badge bg-info bg-opacity-10 text-info">
                  {{ getViolationTypeLabel(violation.type) }}
                </span>
              </td>
              <td>
                <span 
                  class="badge"
                  [class]="getSeverityBadgeClass(violation.severity)">
                  {{ getViolationSeverityLabel(violation.severity) }}
                </span>
              </td>
              <td>
                <span 
                  class="badge"
                  [class]="getStatusBadgeClass(violation.status)">
                  {{ getViolationStatusLabel(violation.status) }}
                </span>
              </td>
              <td>
                <div class="reporter-info">
                  <div class="fw-semibold">{{ violation.reportedBy }}</div>
                  <div class="text-muted small">{{ formatDate(violation.reportedDate) }}</div>
                </div>
              </td>
              <td>
                <div class="date-info">
                  <div>{{ formatDate(violation.reportedDate) }}</div>
                  <div class="text-muted small">{{ formatRelativeDate(violation.reportedDate) }}</div>
                </div>
              </td>
              <td>
                <span 
                  class="badge"
                  [class]="'bg-' + getRiskLevelColor(getRiskLevel(violation)) + ' bg-opacity-10 text-' + getRiskLevelColor(getRiskLevel(violation))">
                  {{ getRiskLevel(violation) }}
                </span>
              </td>
              <td>
                <div class="dropdown">
                  <button 
                    class="btn btn-outline-secondary btn-sm dropdown-toggle" 
                    type="button" 
                    data-bs-toggle="dropdown">
                    <i data-feather="more-horizontal" appFeatherIcon></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                      <a class="dropdown-item" (click)="viewViolation(violation)">
                        <i data-feather="eye" appFeatherIcon class="me-2"></i>
                        View
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item" (click)="editViolation(violation)">
                        <i data-feather="edit" appFeatherIcon class="me-2"></i>
                        Edit
                      </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li *ngIf="violation.status !== ViolationStatus.RESOLVED">
                      <a class="dropdown-item" (click)="updateViolationStatus(violation, ViolationStatus.RESOLVED)">
                        <i data-feather="check" appFeatherIcon class="me-2"></i>
                        Mark as Resolved
                      </a>
                    </li>
                    <li *ngIf="violation.status !== ViolationStatus.DISMISSED">
                       <a class="dropdown-item" (click)="updateViolationStatus(violation, ViolationStatus.DISMISSED)">
                         <i data-feather="x-circle" appFeatherIcon class="me-2"></i>
                         Dismiss
                       </a>
                     </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                      <a class="dropdown-item text-danger" (click)="deleteViolation(violation)">
                        <i data-feather="trash-2" appFeatherIcon class="me-2"></i>
                        Delete
                      </a>
                    </li>
                  </ul>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      <div class="card-footer" *ngIf="totalItems > 0">
        <div class="row align-items-center">
          <div class="col-md-6">
            <div class="pagination-info">
              Showing {{ (currentPage - 1) * pageSize + 1 }} to 
              {{ Math.min(currentPage * pageSize, totalItems) }} of 
              {{ totalItems }} violations
            </div>
          </div>
          <div class="col-md-6">
            <nav aria-label="Violations pagination">
              <ngb-pagination 
                [(page)]="currentPage"
                [pageSize]="pageSize"
                [collectionSize]="totalItems"
                [maxSize]="5"
                [rotate]="true"
                [boundaryLinks]="true"
                (pageChange)="onPageChange($event)">
              </ngb-pagination>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" [class.show]="showDeleteModal" [style.display]="showDeleteModal ? 'block' : 'none'">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Delete</h5>
        <button type="button" class="btn-close" (click)="cancelDelete()"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this violation?</p>
        <div *ngIf="violationToDelete" class="alert alert-warning">
          <strong>{{ violationToDelete.title }}</strong><br>
          <small class="text-muted">{{ violationToDelete.description }}</small>
        </div>
        <p class="text-danger small mb-0">
          <i data-feather="alert-triangle" appFeatherIcon class="me-1"></i>
          This action cannot be undone.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelDelete()">
          Cancel
        </button>
        <button type="button" class="btn btn-danger" (click)="confirmDelete()">
          <i data-feather="trash-2" appFeatherIcon class="me-1"></i>
          Delete Violation
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Bulk Action Confirmation Modal -->
<div class="modal fade" [class.show]="showBulkActionModal" [style.display]="showBulkActionModal ? 'block' : 'none'">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Bulk Action</h5>
        <button type="button" class="btn-close" (click)="cancelBulkAction()"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to {{ selectedBulkAction }} {{ selectedViolations.length }} selected violation(s)?</p>
        <div class="alert alert-warning" *ngIf="selectedBulkAction === 'delete'">
          <i data-feather="alert-triangle" appFeatherIcon class="me-2"></i>
          This action cannot be undone.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelBulkAction()">
          Cancel
        </button>
        <button 
          type="button" 
          class="btn"
          [class]="selectedBulkAction === 'delete' ? 'btn-danger' : 'btn-primary'"
          (click)="executeBulkAction(selectedBulkAction)">
          <i [attr.data-feather]="selectedBulkAction === 'delete' ? 'trash-2' : 'check'" appFeatherIcon class="me-1"></i>
          {{ selectedBulkAction | titlecase }} Violations
        </button>
      </div>
    </div>
  </div>
</div>