<div class="page-content">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center flex-wrap grid-margin">
    <div>
      <h4 class="mb-3 mb-md-0">Upload Credit Report</h4>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
          <li class="breadcrumb-item"><a routerLink="/credit-reports">Credit Reports</a></li>
          <li class="breadcrumb-item active" aria-current="page">Upload</li>
        </ol>
      </nav>
    </div>
    <div class="d-flex align-items-center flex-wrap text-nowrap">
      <button type="button" class="btn btn-outline-secondary btn-icon-text me-2 mb-2 mb-md-0" 
              (click)="onCancel()" [disabled]="uploading">
        <i data-feather="arrow-left" class="btn-icon-prepend"></i>
        Back to Reports
      </button>
    </div>
  </div>

  <!-- Upload Form -->
  <div class="row">
    <div class="col-lg-8 col-xl-9">
      <div class="card">
        <div class="card-body">
          <h6 class="card-title">Report Information</h6>
          
          <form [formGroup]="uploadForm" (ngSubmit)="onSubmit()">
            <div class="row">
              <!-- Client Selection -->
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Client <span class="text-danger">*</span></label>
                  <select class="form-select" formControlName="clientId" 
                          [class.is-invalid]="isFieldInvalid('clientId')">
                    <option value="">Select a client...</option>
                    <option *ngFor="let client of clients" [value]="client.id">
                      {{ client.firstName }} {{ client.lastName }} - {{ client.email }}
                    </option>
                  </select>
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('clientId')">
                    {{ getFieldError('clientId') }}
                  </div>
                </div>
              </div>

              <!-- Credit Bureau -->
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Credit Bureau <span class="text-danger">*</span></label>
                  <select class="form-select" formControlName="bureau" 
                          [class.is-invalid]="isFieldInvalid('bureau')">
                    <option value="">Select credit bureau...</option>
                    <option value="experian">
                      <i [attr.data-feather]="getBureauIcon(CreditBureau.EXPERIAN)"></i>
                      Experian
                    </option>
                    <option value="equifax">
                      <i [attr.data-feather]="getBureauIcon(CreditBureau.EQUIFAX)"></i>
                      Equifax
                    </option>
                    <option value="transunion">
                      <i [attr.data-feather]="getBureauIcon(CreditBureau.TRANSUNION)"></i>
                      TransUnion
                    </option>
                  </select>
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('bureau')">
                    {{ getFieldError('bureau') }}
                  </div>
                </div>
              </div>

              <!-- Report Type -->
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Report Type <span class="text-danger">*</span></label>
                  <select class="form-select" formControlName="reportType" 
                          [class.is-invalid]="isFieldInvalid('reportType')">
                    <option value="">Select report type...</option>
                    <option value="full">Full Credit Report</option>
                    <option value="monitoring">Credit Monitoring Report</option>
                    <option value="dispute">Dispute Response Report</option>
                    <option value="educational">Educational Report</option>
                  </select>
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('reportType')">
                    {{ getFieldError('reportType') }}
                  </div>
                </div>
              </div>

              <!-- Notes -->
              <div class="col-12">
                <div class="mb-3">
                  <label class="form-label">Notes</label>
                  <textarea class="form-control" formControlName="notes" rows="3" 
                            placeholder="Add any additional notes about this report..."></textarea>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- File Upload Section -->
      <div class="card mt-4">
        <div class="card-body">
          <h6 class="card-title">Upload File</h6>
          
          <!-- File Drop Zone -->
          <div class="file-drop-zone" 
               [class.drag-over]="isDragOver"
               [class.has-file]="selectedFile"
               (dragover)="onDragOver($event)"
               (dragleave)="onDragLeave($event)"
               (drop)="onDrop($event)"
               (click)="fileInput.click()">
            
            <input #fileInput type="file" id="fileInput" class="d-none" 
                   [accept]="supportedTypes.join(',')"
                   (change)="onFileSelected($event)">
            
            <div *ngIf="!selectedFile" class="drop-zone-content">
              <i data-feather="upload-cloud" class="upload-icon"></i>
              <h5>Drop your credit report here</h5>
              <p class="text-muted">or <span class="text-primary">click to browse</span></p>
              <small class="text-muted">
                Supported formats: PDF, TXT, CSV, Excel (Max: 10MB)
              </small>
            </div>

            <div *ngIf="selectedFile" class="selected-file">
              <div class="d-flex align-items-center">
                <i [attr.data-feather]="getFileIcon(selectedFile)" class="file-icon me-3"></i>
                <div class="flex-grow-1">
                  <h6 class="mb-1">{{ selectedFile.name }}</h6>
                  <small class="text-muted">{{ formatFileSize(selectedFile.size) }}</small>
                </div>
                <button type="button" class="btn btn-outline-danger btn-sm" 
                        (click)="onRemoveFile(); $event.stopPropagation()">
                  <i data-feather="x"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- File Validation Results -->
          <div *ngIf="fileValidation" class="mt-3">
            <div *ngIf="fileValidation.valid" class="alert alert-success">
              <i data-feather="check-circle" class="me-2"></i>
              File validation passed successfully!
            </div>
            
            <div *ngIf="!fileValidation.valid" class="alert alert-danger">
              <i data-feather="alert-circle" class="me-2"></i>
              File validation failed. Please fix the following errors:
              <ul class="mb-0 mt-2">
                <li *ngFor="let error of fileValidation.errors">{{ error }}</li>
              </ul>
            </div>

            <div *ngIf="fileValidation.warnings.length > 0" class="alert alert-warning">
              <i data-feather="alert-triangle" class="me-2"></i>
              Warnings:
              <ul class="mb-0 mt-2">
                <li *ngFor="let warning of fileValidation.warnings">{{ warning }}</li>
              </ul>
            </div>
          </div>

          <!-- Upload Progress -->
          <div *ngIf="uploading" class="mt-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span>Uploading...</span>
              <span>{{ uploadProgress | number:'1.0-0' }}%</span>
            </div>
            <ngb-progressbar [value]="uploadProgress" [striped]="true" [animated]="true"></ngb-progressbar>
          </div>
        </div>
      </div>

      <!-- Error/Success Messages -->
      <div *ngIf="error" class="alert alert-danger mt-3">
        <i data-feather="alert-circle" class="me-2"></i>
        {{ error }}
      </div>

      <div *ngIf="success" class="alert alert-success mt-3">
        <i data-feather="check-circle" class="me-2"></i>
        {{ success }}
      </div>

      <!-- Action Buttons -->
      <div class="d-flex justify-content-end gap-2 mt-4">
        <button type="button" class="btn btn-outline-secondary" 
                (click)="onCancel()" [disabled]="uploading">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" 
                (click)="onSubmit()" 
                [disabled]="uploadForm.invalid || !selectedFile || uploading || (fileValidation && !fileValidation.valid)">
          <span *ngIf="!uploading">
            <i data-feather="upload" class="btn-icon-prepend"></i>
            Upload Report
          </span>
          <span *ngIf="uploading">
            <div class="spinner-border spinner-border-sm me-2" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            Uploading...
          </span>
        </button>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4 col-xl-3">
      <!-- Upload Guidelines -->
      <div class="card">
        <div class="card-body">
          <h6 class="card-title">Upload Guidelines</h6>
          
          <div class="guideline-item">
            <i data-feather="file-text" class="guideline-icon"></i>
            <div>
              <h6>Supported Formats</h6>
              <p class="text-muted small">PDF, TXT, CSV, Excel files</p>
            </div>
          </div>

          <div class="guideline-item">
            <i data-feather="hard-drive" class="guideline-icon"></i>
            <div>
              <h6>File Size Limit</h6>
              <p class="text-muted small">Maximum 10MB per file</p>
            </div>
          </div>

          <div class="guideline-item">
            <i data-feather="shield" class="guideline-icon"></i>
            <div>
              <h6>Data Security</h6>
              <p class="text-muted small">All files are encrypted and securely stored</p>
            </div>
          </div>

          <div class="guideline-item">
            <i data-feather="zap" class="guideline-icon"></i>
            <div>
              <h6>Auto Processing</h6>
              <p class="text-muted small">Reports are automatically analyzed after upload</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Uploads -->
      <div class="card mt-4" *ngIf="clients.length > 0">
        <div class="card-body">
          <h6 class="card-title">Quick Actions</h6>
          
          <div class="d-grid gap-2">
            <button type="button" class="btn btn-outline-primary btn-sm" 
                    routerLink="/credit-reports">
              <i data-feather="list" class="btn-icon-prepend"></i>
              View All Reports
            </button>
            
            <button type="button" class="btn btn-outline-info btn-sm" 
                    routerLink="/credit-reports/monitoring">
              <i data-feather="activity" class="btn-icon-prepend"></i>
              Credit Monitoring
            </button>
            
            <button type="button" class="btn btn-outline-success btn-sm" 
                    routerLink="/credit-reports/comparison">
              <i data-feather="bar-chart-2" class="btn-icon-prepend"></i>
              Compare Reports
            </button>
          </div>
        </div>
      </div>

      <!-- Help Section -->
      <div class="card mt-4">
        <div class="card-body">
          <h6 class="card-title">Need Help?</h6>
          
          <p class="text-muted small mb-3">
            Having trouble uploading your credit report? Check our help guide or contact support.
          </p>
          
          <div class="d-grid gap-2">
            <button type="button" class="btn btn-outline-secondary btn-sm">
              <i data-feather="help-circle" class="btn-icon-prepend"></i>
              Help Guide
            </button>
            
            <button type="button" class="btn btn-outline-secondary btn-sm">
              <i data-feather="message-circle" class="btn-icon-prepend"></i>
              Contact Support
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading clients...</p>
    </div>
  </div>
</div>