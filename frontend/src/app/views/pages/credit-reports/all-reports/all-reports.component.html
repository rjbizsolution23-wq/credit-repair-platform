<div class="page-content">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center flex-wrap grid-margin">
    <div>
      <h4 class="mb-3 mb-md-0">Credit Reports</h4>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
          <li class="breadcrumb-item active" aria-current="page">Credit Reports</li>
        </ol>
      </nav>
    </div>
    <div class="d-flex align-items-center flex-wrap text-nowrap">
      <button type="button" class="btn btn-outline-primary btn-icon-text me-2 mb-2 mb-md-0" 
              (click)="onRefresh()" [disabled]="loading">
        <i data-feather="refresh-cw" class="btn-icon-prepend"></i>
        Refresh
      </button>
      <button type="button" class="btn btn-primary btn-icon-text mb-2 mb-md-0" 
              routerLink="/credit-reports/upload">
        <i data-feather="upload" class="btn-icon-prepend"></i>
        Upload Report
      </button>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row" *ngIf="stats">
    <div class="col-md-3 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-baseline">
            <h6 class="card-title mb-0">Total Reports</h6>
            <div class="mb-2">
              <i data-feather="file-text" class="icon-sm text-muted"></i>
            </div>
          </div>
          <div class="row">
            <div class="col-6 col-md-12 col-xl-5">
              <h3 class="mb-2">{{ stats.totalReports | number }}</h3>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-baseline">
            <h6 class="card-title mb-0">Average Score</h6>
            <div class="mb-2">
              <i data-feather="trending-up" class="icon-sm text-muted"></i>
            </div>
          </div>
          <div class="row">
            <div class="col-6 col-md-12 col-xl-5">
              <h3 class="mb-2" [class]="'text-' + getScoreColor(stats.averageScore)">{{ stats.averageScore }}</h3>
              <div class="d-flex align-items-baseline">
                <p class="text-muted">{{ getScoreRange(stats.averageScore) }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-baseline">
            <h6 class="card-title mb-0">Score Improvement</h6>
            <div class="mb-2">
              <i data-feather="arrow-up" class="icon-sm text-success"></i>
            </div>
          </div>
          <div class="row">
            <div class="col-6 col-md-12 col-xl-5">
              <h3 class="mb-2 text-success">+{{ stats.scoreImprovement }}</h3>
              <div class="d-flex align-items-baseline">
                <p class="text-muted">Average improvement</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-baseline">
            <h6 class="card-title mb-0">This Month</h6>
            <div class="mb-2">
              <i data-feather="calendar" class="icon-sm text-muted"></i>
            </div>
          </div>
          <div class="row">
            <div class="col-6 col-md-12 col-xl-5">
              <h3 class="mb-2">{{ stats.reportsThisMonth | number }}</h3>
              <div class="d-flex align-items-baseline">
                <p class="text-muted">New reports</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters and Search -->
  <div class="row">
    <div class="col-12 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <form [formGroup]="filterForm">
            <div class="row">
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Search</label>
                  <div class="input-group">
                    <span class="input-group-text"><i data-feather="search"></i></span>
                    <input type="text" class="form-control" formControlName="search" 
                           placeholder="Search reports...">
                  </div>
                </div>
              </div>
              <div class="col-md-2">
                <div class="mb-3">
                  <label class="form-label">Client</label>
                  <select class="form-select" formControlName="clientId">
                    <option value="">All Clients</option>
                    <option *ngFor="let client of clients" [value]="client.id">
                      {{ client.firstName }} {{ client.lastName }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="col-md-2">
                <div class="mb-3">
                  <label class="form-label">Bureau</label>
                  <select class="form-select" formControlName="bureau">
                    <option value="">All Bureaus</option>
                    <option value="experian">Experian</option>
                    <option value="equifax">Equifax</option>
                    <option value="transunion">TransUnion</option>
                  </select>
                </div>
              </div>
              <div class="col-md-2">
                <div class="mb-3">
                  <label class="form-label">Status</label>
                  <select class="form-select" formControlName="status">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="processing">Processing</option>
                    <option value="completed">Completed</option>
                    <option value="error">Error</option>
                    <option value="archived">Archived</option>
                  </select>
                </div>
              </div>
              <div class="col-md-2">
                <div class="mb-3">
                  <label class="form-label">&nbsp;</label>
                  <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary" 
                            (click)="onToggleAdvancedFilters()">
                      <i data-feather="filter"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" 
                            (click)="onClearFilters()">
                      <i data-feather="x"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Advanced Filters -->
            <div class="row" *ngIf="showAdvancedFilters">
              <div class="col-12">
                <hr>
                <h6>Advanced Filters</h6>
              </div>
              <div class="col-md-2">
                <div class="mb-3">
                  <label class="form-label">Report Type</label>
                  <select class="form-select" formControlName="reportType">
                    <option value="">All Types</option>
                    <option value="full">Full Report</option>
                    <option value="monitoring">Monitoring</option>
                    <option value="dispute">Dispute</option>
                    <option value="educational">Educational</option>
                  </select>
                </div>
              </div>
              <div class="col-md-2">
                <div class="mb-3">
                  <label class="form-label">Date From</label>
                  <input type="date" class="form-control" formControlName="dateFrom">
                </div>
              </div>
              <div class="col-md-2">
                <div class="mb-3">
                  <label class="form-label">Date To</label>
                  <input type="date" class="form-control" formControlName="dateTo">
                </div>
              </div>
              <div class="col-md-2">
                <div class="mb-3">
                  <label class="form-label">Min Score</label>
                  <input type="number" class="form-control" formControlName="scoreMin" 
                         min="300" max="850" placeholder="300">
                </div>
              </div>
              <div class="col-md-2">
                <div class="mb-3">
                  <label class="form-label">Max Score</label>
                  <input type="number" class="form-control" formControlName="scoreMax" 
                         min="300" max="850" placeholder="850">
                </div>
              </div>
              <div class="col-md-2">
                <div class="mb-3">
                  <label class="form-label">Negative Items</label>
                  <select class="form-select" formControlName="hasNegativeItems">
                    <option [ngValue]="null">All Reports</option>
                    <option [ngValue]="true">With Negative Items</option>
                    <option [ngValue]="false">Without Negative Items</option>
                  </select>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Actions -->
  <div class="row" *ngIf="selectedReports.size > 0">
    <div class="col-12">
      <div class="alert alert-info d-flex justify-content-between align-items-center">
        <span>{{ selectedReports.size }} report(s) selected</span>
        <div class="btn-group">
          <button type="button" class="btn btn-sm btn-outline-warning" 
                  (click)="onBulkArchive()">
            <i data-feather="archive" class="btn-icon-prepend"></i>
            Archive
          </button>
          <button type="button" class="btn btn-sm btn-outline-danger" 
                  (click)="onBulkDelete()">
            <i data-feather="trash-2" class="btn-icon-prepend"></i>
            Delete
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Reports Table -->
  <div class="row">
    <div class="col-12 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="card-title">Credit Reports ({{ totalItems }})</h6>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-sm btn-outline-primary" 
                      (click)="onExport()">
                <i data-feather="download" class="btn-icon-prepend"></i>
                Export
              </button>
            </div>
          </div>

          <!-- Loading State -->
          <div *ngIf="loading" class="text-center py-4">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading credit reports...</p>
          </div>

          <!-- Error State -->
          <div *ngIf="error" class="alert alert-danger">
            <i data-feather="alert-circle" class="me-2"></i>
            {{ error }}
          </div>

          <!-- Empty State -->
          <div *ngIf="!loading && !error && filteredReports.length === 0" class="text-center py-5">
            <i data-feather="file-text" class="icon-lg text-muted mb-3"></i>
            <h5>No Credit Reports Found</h5>
            <p class="text-muted">No credit reports match your current filters.</p>
            <button type="button" class="btn btn-primary" routerLink="/credit-reports/upload">
              Upload First Report
            </button>
          </div>

          <!-- Reports Table -->
          <div *ngIf="!loading && !error && filteredReports.length > 0" class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input" 
                             [checked]="selectAll" (change)="onSelectAll()">
                    </div>
                  </th>
                  <th (click)="onSort('clientId')" class="sortable">
                    Client
                    <i *ngIf="sortField === 'clientId'" 
                       [attr.data-feather]="sortDirection === 'asc' ? 'chevron-up' : 'chevron-down'"></i>
                  </th>
                  <th (click)="onSort('bureau')" class="sortable">
                    Bureau
                    <i *ngIf="sortField === 'bureau'" 
                       [attr.data-feather]="sortDirection === 'asc' ? 'chevron-up' : 'chevron-down'"></i>
                  </th>
                  <th (click)="onSort('score')" class="sortable">
                    Score
                    <i *ngIf="sortField === 'score'" 
                       [attr.data-feather]="sortDirection === 'asc' ? 'chevron-up' : 'chevron-down'"></i>
                  </th>
                  <th (click)="onSort('reportDate')" class="sortable">
                    Report Date
                    <i *ngIf="sortField === 'reportDate'" 
                       [attr.data-feather]="sortDirection === 'asc' ? 'chevron-up' : 'chevron-down'"></i>
                  </th>
                  <th (click)="onSort('reportType')" class="sortable">
                    Type
                    <i *ngIf="sortField === 'reportType'" 
                       [attr.data-feather]="sortDirection === 'asc' ? 'chevron-up' : 'chevron-down'"></i>
                  </th>
                  <th (click)="onSort('status')" class="sortable">
                    Status
                    <i *ngIf="sortField === 'status'" 
                       [attr.data-feather]="sortDirection === 'asc' ? 'chevron-up' : 'chevron-down'"></i>
                  </th>
                  <th>Accounts</th>
                  <th>Negative Items</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let report of getPaginatedReports()">
                  <td>
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input" 
                             [checked]="selectedReports.has(report.id)"
                             (change)="onSelectReport(report.id)">
                    </div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="avatar avatar-sm me-2">
                        <span class="avatar-title rounded-circle bg-secondary">
                          {{ getClientName(report.clientId).charAt(0) }}
                        </span>
                      </div>
                      <div>
                        <h6 class="mb-0">{{ getClientName(report.clientId) }}</h6>
                        <small class="text-muted">{{ report.clientId }}</small>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <i [attr.data-feather]="getBureauIcon(report.bureau)" class="icon-sm me-2"></i>
                      <span class="text-capitalize">{{ report.bureau }}</span>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <h6 class="mb-0" [class]="'text-' + getScoreColor(report.score)">{{ report.score }}</h6>
                      <small class="text-muted ms-2">{{ getScoreRange(report.score) }}</small>
                    </div>
                  </td>
                  <td>{{ formatDate(report.reportDate) }}</td>
                  <td>
                    <span class="text-capitalize">{{ report.reportType.replace('_', ' ') }}</span>
                  </td>
                  <td>
                    <span class="badge" [class]="getStatusClass(report.status)">
                      {{ report.status.replace('_', ' ') | titlecase }}
                    </span>
                  </td>
                  <td>{{ report.accounts?.length || 0 }}</td>
                  <td>
                    <span class="badge" 
                          [class]="hasNegativeAccounts(report) ? 'badge-danger' : 'badge-success'">
                      {{ getNegativeAccountsCount(report) }}
                    </span>
                  </td>
                  <td>
                    <div class="dropdown">
                      <button class="btn btn-link p-0" type="button" 
                              [attr.data-bs-toggle]="'dropdown'" aria-expanded="false">
                        <i data-feather="more-horizontal"></i>
                      </button>
                      <ul class="dropdown-menu">
                        <li>
                          <a class="dropdown-item" (click)="onViewReport(report.id)">
                            <i data-feather="eye" class="me-2"></i>
                            View Analysis
                          </a>
                        </li>
                        <li>
                          <a class="dropdown-item" (click)="onEditReport(report.id)">
                            <i data-feather="edit" class="me-2"></i>
                            Edit
                          </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                          <a class="dropdown-item" (click)="onReprocessReport(report.id)">
                            <i data-feather="refresh-cw" class="me-2"></i>
                            Reprocess
                          </a>
                        </li>
                        <li>
                          <a class="dropdown-item" (click)="onArchiveReport(report.id)">
                            <i data-feather="archive" class="me-2"></i>
                            Archive
                          </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                          <a class="dropdown-item text-danger" (click)="onDeleteReport(report.id)">
                            <i data-feather="trash-2" class="me-2"></i>
                            Delete
                          </a>
                        </li>
                      </ul>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div *ngIf="totalItems > pageSize" class="d-flex justify-content-between align-items-center mt-3">
            <div class="d-flex align-items-center">
              <span class="me-3">Show</span>
              <select class="form-select form-select-sm" style="width: auto;" 
                      [ngModel]="pageSize" (ngModelChange)="onPageSizeChange($event)">
                <option [value]="10">10</option>
                <option [value]="25">25</option>
                <option [value]="50">50</option>
                <option [value]="100">100</option>
              </select>
              <span class="ms-3">entries</span>
            </div>
            <ngb-pagination
              [(page)]="currentPage"
              [pageSize]="pageSize"
              [collectionSize]="totalItems"
              [maxSize]="5"
              [rotate]="true"
              [boundaryLinks]="true"
              (pageChange)="onPageChange($event)">
            </ngb-pagination>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>